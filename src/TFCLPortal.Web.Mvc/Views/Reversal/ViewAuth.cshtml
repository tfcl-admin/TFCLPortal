@model TFCLPortal.Reversals.Dto.ReversalListDto
@{
    Layout = "~/Views/Shared/_NewLayout.cshtml";
}

<style>
    .text-danger td {
        color: red;
    }

    .text-danger-light td {
        color: #df0202;
    }

    .text-reversed td {
        color: #808080;
    }
</style>

<main class='main-content bgc-grey-100' style="padding-top:50px">
    <div class="row page-title">
        <div class="col-md-6 text-left">
            <h4 class="page-title-text">
                Reversal Requests Authorization
            </h4>
            <h6 class="page-title-breadcrumbs">
                <a href="~/Dashboard/Dashboard">Home</a> > Authorizations > Reversal Requests Authorization
            </h6>
        </div>
        <div class="col-md-6 text-right">
            @*<button class="btn btn-sm btn-outline-success" onclick="$('#filterForm').toggle();"><i class="fa fa-filter"></i> Filter Records</button>*@
            <a href="~/Dashboard/Dashboard" class="btn btn-sm btn-outline-success bg1 eft-1" title="Back"><i class="fa fa-angle-double-left"></i> Back To Home </a>
        </div>
    </div>
    <div class="card p-10 mB-20">
        <input type="hidden" id="Id" value="@Model.Id" />
        @if (Model != null)
        {
            <div class="bgc-white bd bdrs-3 p-20 ">
                <div class="row">
                    <div class="col-md-4">
                        <p class="detailHeading">
                            Client ID
                        </p>
                        <p class="detailText">
                            @Model.ClientId
                        </p>
                    </div>
                    <div class="col-md-4">
                        <p class="detailHeading">
                            Client Name
                        </p>
                        <p class="detailText">
                            @Model.ClientName
                        </p>
                    </div>
                    <div class="col-md-4">
                        <p class="detailHeading">
                            School/Business Name
                        </p>
                        <p class="detailText">
                            @Model.SchoolName
                        </p>
                    </div>

                    <div class="col-md-12">

                        <table class="table table-striped table-bordered" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>
                                        Sr
                                    </th>
                                    <th>
                                        Entry Date & Time
                                    </th>
                                    <th>
                                        Deposit Date & Time
                                    </th>

                                    <th>
                                        Narration
                                    </th>
                                    <th>
                                        Reference
                                    </th>
                                    <th style="text-align:right">
                                        Debit
                                    </th>
                                    <th style="text-align:right">
                                        Credit
                                    </th>
                                    <th style="text-align:right">
                                        Balance
                                    </th>
                                    <th class="statusCol">
                                        Status
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ int i = 1;}
                                @foreach (var item in Model.transactions.OrderBy(x => x.CreationTime))
                                {
                                    <tr class="@(item.Id==Model.TransactionId?"text-danger":"") @(item.Id>Model.TransactionId?"text-danger-light":"") @(item.isReversed?"text-reversed":"")">
                                        <td>@(i++)</td>
                                        <td>@item.CreationTime.ToString("dd-MMM-yyyy")</td>
                                        <td>@(item.Type=="Credit" ? item.DepositDate.ToString("dd-MMM-yyyy") : "--")</td>
                                        <td>@(item.Details == ""|| item.Details == null ? item.ModeOfPayment : item.Details)</td>
                                        <td>@(item.Reference == ""|| item.Reference == null ? "--" : item.Reference)</td>
                                        <td style="text-align:right">@(item.Type=="Debit" ? (item.Amount == 0 ? "0" : string.Format("{0:#,##0}", item.Amount)) : "--")</td>
                                        <td style="text-align:right">@(item.Type=="Credit" ? (item.Amount == 0 ? "0" : string.Format("{0:#,##0}", item.Amount)) : "--")</td>
                                        <td style="text-align:right">@(item.BalAfter == 0 ? "0" : string.Format("{0:#,##0}", item.BalAfter))</td>
                                        <td class="statusCol">
                                            @if (item.isAuthorized == true)
                                            {
                                                <i class="fa fa-check" title="Authorized" alt="Y"></i>
                                            }
                                            else if (item.isAuthorized == null)
                                            {
                                                <i class="fa fa-info-circle" title="Pending" alt="P"></i>
                                            }
                                            else
                                            {
                                                <i class="fa fa-times" title="Rejected" alt="N"></i>

                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    @if (Model.isAuthorized == null)
                    {
                <div class="col-md-12 text-right">
                        <ul class="list-inline  d-inline pr-5">
                            <li class="list-inline-item"><i class="fa fa-circle" style="color: black"></i> Earlier Transactions</li>
                            <li class="list-inline-item"><i class="fa fa-circle" style="color: #ff0000"></i> Reversal Transaction</li>
                            <li class="list-inline-item"><i class="fa fa-circle" style="color: #df0202"></i> Affected Transactions</li>
                        </ul>
                    <input id="RejectionReason" type="text" style="width:25%;" class="form-control d-inline" placeholder="Reason For Rejection" />
                    <a class="btn btn-outline-danger d-inline" style="color: red !important;padding:8px" onclick="Authorize(0);"><i class="fa fa-times"></i> Reject Reversal</a>
                    <a class="btn btn-outline-success d-inline" style="color: green !important;padding:8px" onclick="Authorize(1);"><i class="fa fa-upload"></i> Authorize Reversal</a>
                </div>
                    }
                </div>
            </div>
        }

    </div>
</main>
<script src="https://code.jquery.com/jquery-3.5.1.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" crossorigin="anonymous"></script>
<script src="~/vendor/numwords/index.js" crossorigin="anonymous"></script>

<script>


    function Authorize(isAuth) {
        var RejectionReason = $('#RejectionReason').val();
        var Id = $('#Id').val();

        var formData = new FormData();
        var isError = 0;
        if (!isAuth && RejectionReason == "") {
            abp.notify.error("Error", "Please Enter Rejection Reason");
            isError = 1;
        }
        else if (isAuth) {
            formData.append('Id', Id);
            formData.append('Decision', 'Authorize');
            formData.append('Reason', RejectionReason);
        }
        else if (!isAuth) {
            formData.append('Id', Id);
            formData.append('Decision', 'Reject');
            formData.append('Reason', RejectionReason);
        }

        if (isError == 0) {
               $.ajax({
                    type: 'POST',
                    datatype: "json",
                    processData: false,
                    contentType: false,
                    url: '@Url.Content("~/Reversal/Authorize")',
                    data: formData,
                    success: function (data) {
                        var returnData = data.result;
                        abp.notify.success(returnData, "Success");
                        window.location = '/Reversal/AuthList';
                    },
                    error: function (data) {
                        abp.notify.error("Some error occure contact with admin..!", "error");
                        console.log(data);
                    }
                });
        }

    }


</script>